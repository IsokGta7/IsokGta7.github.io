<script>
    $(document).ready(function () {
        $('.modal').modal({
            dismissible: false
        });

        M.toast({
            html: 'Cargando modelo. Por favor espere..',
            displayLength: Infinity,
            classes: 'rounded blue'
        });

        // Initialize YOLO
        window.yolo = ml5.YOLO(modelLoaded, {
            filterBoxesThreshold: 0.01,
            IOUThreshold: 0.01,
            classProbThreshold: 0.5
        });

        function modelLoaded() {
            M.Toast.dismissAll();
            M.toast({
                html: 'Modelo cargado exitosamente',
                displayLength: 1000,
                classes: 'rounded green'
            });
            $('.btn-large').removeClass('disabled');
        }
    });

    // Load video and start YOLO detection
    function loadVideo(event) {
        const video = document.getElementById('uploaded_video');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d');
        const file = event.target.files[0];
        const url = URL.createObjectURL(file);
        video.src = url;

        video.addEventListener('loadeddata', () => {
            video.play();
            detectObjects(video, ctx);
        });
    }

    function detectObjects(video, ctx) {
        const detectFrame = () => {
            if (video.paused || video.ended) return;

            // Detect objects in the video frame
            yolo.detect(video, (err, results) => {
                if (err) {
                    console.error(err);
                    return;
                }

                // Clear previous drawings
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                // Draw the current video frame to the canvas
                ctx.drawImage(video, 0, 0, ctx.canvas.width, ctx.canvas.height);

                // Draw bounding boxes and labels for each detected object
                if (results && results.length > 0) {
                    results.forEach(result => {
                        ctx.beginPath();
                        ctx.rect(result.x * canvas.width, result.y * canvas.height, result.width * canvas.width, result.height * canvas.height);
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = 'red'; // Box color
                        ctx.stroke();

                        ctx.fillStyle = 'red'; // Text color
                        ctx.font = '14px Arial';
                        ctx.fillText(
                            `${result.label} (${(result.confidence * 100).toFixed(2)}%)`,
                            result.x * canvas.width,
                            result.y * canvas.height > 10 ? result.y * canvas.height - 5 : 10
                        );
                    });

                    // Update object count in the UI
                    document.querySelector('.objno').textContent = "Objetos detectados: " + results.length;
                }
            });

            requestAnimationFrame(detectFrame); // Request the next frame for detection
        };

        detectFrame(); // Start the detection loop
    }

    function openVideoUpload() {
        // Open the video upload modal
        $('#modal2').modal('open');
    }
</script>