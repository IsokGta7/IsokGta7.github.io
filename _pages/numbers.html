---
layout: default
title: Numbers
permalink: /numbers/
---

<div class="login-container">
    <h2>Numbers</h2>
</div>

<div class="canvas-container">
    <h1>Dibuja un número para que el modelo diga que número es más probable que sea</h1>
    <canvas id="drawingCanvas" width="280" height="280" style="border:1px solid black;"></canvas>
    <br>
    <button id="predictButton" disabled>Predecir</button>
    <button id="clearButton">Limpiar Canvas</button>
    <h2>Resultado: <span id="result"></span></h2>
    <p id="status">Cargando el modelo...</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script>
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const predictButton = document.getElementById('predictButton');
    const clearButton = document.getElementById('clearButton');
    const statusText = document.getElementById('status');
    let isDrawing = false;
    let model;

    async function loadModel() {
        try {
            model = await tf.loadLayersModel('model_numbers.json');
            console.log("Modelo cargado correctamente:", model.summary());
            statusText.innerText = "Modelo cargado.";
            predictButton.disabled = false;
        } catch (error) {
            console.error("Error al cargar el modelo:", error);
            statusText.innerText = "Error cargando el modelo.";
        }
    }

    //Preprocesar el lienzo
    async function preprocessCanvas() {
        let image = tf.browser.fromPixels(canvas, 1); // 1 canal para escala de grises
        image = tf.image.resizeBilinear(image, [28, 28]);
        console.log("Antes de normalizar:", image.arraySync()); // Ver los valores antes de la normalización
        image = image.div(255.0); // Normalización
        console.log("Después de normalizar:", image.arraySync()); // Ver los valores después de la normalización

        const reshaped = image.expandDims(0); // Añadir dimensión para batch
        return reshaped;
    }


    // Obtener la posición del mouse en el canvas
    function getMousePosition(canvas, event) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: event.clientX - rect.left,
            y: event.clientY - rect.top
        };
    }

    // Dibujar en el lienzo
    canvas.addEventListener('mousedown', (event) => {
        isDrawing = true;
        const mousePos = getMousePosition(canvas, event);
        ctx.beginPath();
        ctx.moveTo(mousePos.x, mousePos.y);
    });

    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
    });

    canvas.addEventListener('mousemove', (event) => {
        if (!isDrawing) return;
        const mousePos = getMousePosition(canvas, event);
        ctx.lineWidth = 15; // Aumentar el grosor para facilitar el dibujo
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'black';
        ctx.lineTo(mousePos.x, mousePos.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(mousePos.x, mousePos.y);
    });

    // Limpiar el lienzo
    clearButton.addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('result').innerText = "";
    });


    async function predictDigit() {
        if (!model) {
            alert("El modelo no se ha cargado todavía.");
            return;
        }
        try {
            const inputTensor = await preprocessCanvas();
            console.log("Tensor de entrada:", inputTensor.arraySync()); // Asegúrate de ver el tensor de entrada

            // Asegúrate de que el tensor esté en la forma correcta
            const predictions = model.predict(inputTensor);
            const predictedClass = predictions.argMax(-1).dataSync()[0];

            document.getElementById('result').innerText = predictedClass;
            console.log(predictions.arraySync()); // Muestra la distribución de probabilidades
            console.log(predictedClass); // Muestra la clase predicha
            console.log("Forma del tensor de entrada:", inputTensor.shape);

        } catch (error) {
            console.error("Error durante la predicción:", error);
        }
    }



    // Escuchar clic del botón de predicción
    predictButton.addEventListener('click', predictDigit);

    // Cargar el modelo al cargar la página
    window.onload = loadModel;
</script>

<style>
    .canvas-container {
        margin-top: 20px;
        text-align: center;
    }

    #drawingCanvas {
        cursor: crosshair;
        width: 280px;
        /* Ampliación para visibilidad */
        height: 280px;
    }

    #status {
        font-style: italic;
        color: gray;
    }
</style>